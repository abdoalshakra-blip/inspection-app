<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Material Inspection Reporting App</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 0; background:#f9f9f9; }
header { background:#2c3e50; color:#fff; padding:1rem; text-align:center; }
main { padding:1rem; }
.hidden { display:none; }
.btn { background:#3498db; color:#fff; border:none; padding:0.8rem 1.5rem; margin:0.3rem; border-radius:6px; cursor:pointer; font-size:1rem; }
.btn:hover { background:#2980b9; }
input, select, textarea { width:100%; padding:0.5rem; margin:0.3rem 0; border:1px solid #ccc; border-radius:4px; }
table { width:100%; border-collapse: collapse; margin-top:1rem; }
table, th, td { border:1px solid #ccc; }
th, td { padding:0.5rem; text-align:left; }
.report-section { background:#fff; padding:1rem; margin-top:1rem; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
img, video { max-width:150px; margin:5px; display:inline-block; vertical-align:top; }
video#cameraPreview { width:100%; max-width:400px; border:1px solid #ccc; border-radius:6px; margin-bottom:0.5rem; }
@media print {
  body * { visibility:hidden; }
  #reportView, #reportView * { visibility:visible; }
  #reportView { position:absolute; top:0; left:0; width:100%; }
}
</style>
</head>
<body>
<header><h1>Material Inspection Reporting</h1></header>
<main>
<div id="dashboard">
  <button class="btn" onclick="startNewInspection()">New Inspection</button>
  <button class="btn" onclick="viewReports()">View Reports</button>
</div>

<div id="inspectionForm" class="hidden">
  <h2>New Inspection</h2>
  <label>PO Number</label><input type="text" id="poNumber" required>
  <label>PO Date</label><input type="date" id="poDate" required>
  <label>Delivery Date</label><input type="date" id="deliveryDate" required>
  <label>Supplier Name</label><input type="text" id="supplierName" required>
  <label>Inspector Name</label><input type="text" id="inspectorName" required>

  <h3>Materials</h3>
  <table id="materialsTable">
    <thead>
      <tr>
        <th>Material Name</th>
        <th>PO Qty</th>
	<th>Delivered Qty</th>
	<th>Unit</th>
        <th>Observation</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <button class="btn" onclick="addMaterial()">Add Material</button>

  <h3>Attach Media (Photo / Video)</h3>
  <video id="cameraPreview" class="hidden" autoplay muted></video>
  <button class="btn" onclick="openCamera()">Open Camera / Upload</button>
  <button class="btn hidden" id="capturePhotoBtn" onclick="capturePhoto()">Capture Photo</button>
  <button class="btn hidden" id="captureVideoBtn" onclick="captureVideo()">Start/Stop Video</button>
  <input type="file" id="mediaInput" accept="image/*,video/*" capture="environment" multiple class="hidden">

  <h3>Conclusion Note</h3>
  <textarea id="conclusionNote" rows="4"></textarea>

  <button class="btn" onclick="generateReport()">Generate Report</button>
  <button class="btn" onclick="resetForm()">New Inspection</button>
</div>

<div id="reportView" class="hidden report-section"></div>
<div id="reportActions" class="hidden">
  <button class="btn" onclick="exportExcel()">Export to Excel</button>
  <button class="btn" onclick="emailReport()">Email Report</button>
  <button class="btn" onclick="printReport()">Print Report</button>
</div>
</main>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script>
const materialsTable = document.querySelector("#materialsTable tbody");
let currentReport = null;
let capturedMedia = [];
let capturedImagesBase64 = [];
let cameraStream = null;
let mediaRecorder = null;
let videoChunks = [];
let recording = false;

// Materials
function addMaterial() {
  const row = document.createElement("tr");
  row.innerHTML = `
    <td><input type="text" placeholder="Material Name"></td>
    <td><input type="number" placeholder="PO Qty"></td>
    <td><input type="number" placeholder="Delivered Qty"></td>
    <td>
      <select>
	<option value="Each">Each</option>
        <option value="PCS">PCS</option>
	<option value="Pack">Pack</option>
	<option value="Box">Box</option>
        <option value="KG">KG</option>
        <option value="Ltr">L</option>
        <option value="M">M</option>
	<option value="M2">M2</option>
	<option value="M3">M3</option>
	<option value="Ton">Ton</option>
        <option value="Other">Other</option>
      </select>
    </td>
    <td><input type="text" placeholder="Observation"></td>
    <td>
      <select>
        <option value="Accepted">Accepted</option>
        <option value="Rejected">Rejected</option>
      </select>
    </td>`;
  materialsTable.appendChild(row);
}

// Inspection Form Control
function startNewInspection() {
  document.getElementById("dashboard").classList.add("hidden");
  document.getElementById("inspectionForm").classList.remove("hidden");
  document.getElementById("reportView").classList.add("hidden");
  document.getElementById("reportActions").classList.add("hidden");
  resetForm();
  addMaterial();
}

function resetForm() {
  document.getElementById("poNumber").value = "";
  document.getElementById("poDate").value = "";
  document.getElementById("deliveryDate").value = "";
  document.getElementById("supplierName").value = "";
  document.getElementById("inspectorName").value = "";
  document.getElementById("conclusionNote").value = "";
  materialsTable.innerHTML = "";
  capturedMedia = [];
  capturedImagesBase64 = [];
  stopCamera();
  document.getElementById("mediaInput").value = "";
  document.getElementById("cameraPreview").classList.add("hidden");
  document.getElementById("capturePhotoBtn").classList.add("hidden");
  document.getElementById("captureVideoBtn").classList.add("hidden");
}

// Camera & Capture
function openCamera() {
  const video = document.getElementById("cameraPreview");
  const photoBtn = document.getElementById("capturePhotoBtn");
  const videoBtn = document.getElementById("captureVideoBtn");
  video.classList.remove("hidden");
  photoBtn.classList.remove("hidden");
  videoBtn.classList.remove("hidden");

  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: true, audio: true })
      .then(stream => {
        cameraStream = stream;
        video.srcObject = stream;
      })
      .catch(err => { console.error(err); alert("Cannot access camera."); });
  } else {
    document.getElementById("mediaInput").click();
  }
}

function capturePhoto() {
  const video = document.getElementById("cameraPreview");
  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext("2d").drawImage(video,0,0,canvas.width,canvas.height);
  canvas.toBlob(blob => {
    const file = new File([blob], `photo_${Date.now()}.png`, { type: "image/png" });
    capturedMedia.push(file);
    // Convert to base64 for email embedding
    const reader = new FileReader();
    reader.onload = function(e){ capturedImagesBase64.push(e.target.result); }
    reader.readAsDataURL(file);
    alert("Photo captured!");
  });
}

function captureVideo() {
  if (!recording) {
    videoChunks = [];
    mediaRecorder = new MediaRecorder(cameraStream);
    mediaRecorder.ondataavailable = e => { if(e.data.size > 0) videoChunks.push(e.data); };
    mediaRecorder.onstop = () => {
      const blob = new Blob(videoChunks, { type: "video/mp4" });
      const file = new File([blob], `video_${Date.now()}.mp4`, { type: "video/mp4" });
      capturedMedia.push(file);
      alert("Video captured!");
    };
    mediaRecorder.start();
    recording = true;
    document.getElementById("captureVideoBtn").innerText = "Stop Video";
  } else {
    mediaRecorder.stop();
    recording = false;
    document.getElementById("captureVideoBtn").innerText = "Start Video";
  }
}

function stopCamera() {
  if(cameraStream) {
    cameraStream.getTracks().forEach(track => track.stop());
    cameraStream = null;
  }
}

// Generate Report
function generateReport() {
  stopCamera();
  const poNumber = document.getElementById("poNumber").value;
  const poDate = document.getElementById("poDate").value;
  const deliveryDate = document.getElementById("deliveryDate").value;
  const supplierName = document.getElementById("supplierName").value;
  const inspectorName = document.getElementById("inspectorName").value;
  const conclusionNote = document.getElementById("conclusionNote").value;
  const timestamp = new Date().toLocaleString();

  const materials = [];
  [...materialsTable.querySelectorAll("tr")].forEach(row => {
    const cells = row.querySelectorAll("td input, td select");
    materials.push({
      name: cells[0].value,
      poQty: cells[1].value,
      deliveredQty: cells[2].value,
      unit: cells[3].value,
      observation: cells[4].value,
      status: cells[5].value
    });
  });

  const uploadedFiles = [...document.getElementById("mediaInput").files];
  const mediaFiles = [...capturedMedia, ...uploadedFiles];
  currentReport = { poNumber, poDate, deliveryDate, supplierName, inspectorName, materials, conclusionNote, mediaFiles, timestamp };

  let html = `<h2>Inspection Report</h2>
    <p><strong>PO Number:</strong> ${poNumber}</p>
    <p><strong>PO Date:</strong> ${poDate}</p>
    <p><strong>Delivery Date:</strong> ${deliveryDate}</p>
    <p><strong>Supplier:</strong> ${supplierName}</p>
    <p><strong>Inspector:</strong> ${inspectorName}</p>
    <p><strong>Inspection Timestamp:</strong> ${timestamp}</p>
    <h3>Materials</h3>
    <table>
      <tr><th>Name</th><th>PO Qty</th><th>Delivered Qty</th><th>Unit</th><th>Observation</th><th>Status</th></tr>`;
  materials.forEach(m => {
    html += `<tr><td>${m.name}</td><td>${m.poQty}</td><td>${m.deliveredQty}</td><td>${m.unit}</td><td>${m.observation}</td><td>${m.status}</td></tr>`;
  });
  html += `</table><h3>Media</h3>`;
  mediaFiles.forEach(file => {
    const url = URL.createObjectURL(file);
    if(file.type.startsWith("image")) html += `<img src="${url}" alt="image">`;
    else html += `<video src="${url}" controls></video>`;
  });
  html += `<h3>Conclusion Note</h3><p>${conclusionNote}</p>`;

  document.getElementById("reportView").innerHTML = html;
  document.getElementById("reportView").classList.remove("hidden");
  document.getElementById("reportActions").classList.remove("hidden");
}

// Excel, Email, Print
function exportExcel() {
  if (!currentReport) return;
  const data = currentReport.materials.map(m => ({
    "PO Number": currentReport.poNumber,
    "PO Date": currentReport.poDate,
    "Material Name": m.name,
    "PO Quantity": m.poQty,
    "Delivered Quantity": m.deliveredQty,
    "Unit": m.unit,
    "Observation Note": m.observation,
    "Delivery Date": currentReport.deliveryDate,
    "Status": m.status,
    "Conclusion Note": currentReport.conclusionNote,
    "Inspector": currentReport.inspectorName,
    "Timestamp": currentReport.timestamp
  }));
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Report");
  XLSX.writeFile(wb, "inspection_report.xlsx");
}

function emailReport() {
  if (!currentReport) return;

  const nl = "%0D%0A";

  // helper to pad/truncate strings
  function fmt(val, len, align = "left") {
    let s = val === null || val === undefined ? "" : String(val);
    if (s.length > len) s = s.slice(0, len); // truncate
    return align === "right" ? s.padStart(len, " ") : s.padEnd(len, " ");
  }

  let body = `Dear Team,${nl}${nl}`;
  body += `Please find the Inspection Report below.${nl}${nl}`;
  body += `PO Number: ${currentReport.poNumber}${nl}`;
  body += `PO Date: ${currentReport.poDate}${nl}`;
  body += `Delivery Date: ${currentReport.deliveryDate}${nl}`;
  body += `Supplier: ${currentReport.supplierName}${nl}`;
  body += `Inspector: ${currentReport.inspectorName}${nl}`;
  body += `Inspection Timestamp: ${currentReport.timestamp}${nl}${nl}`;
  body += `Materials:${nl}`;

  // Add materials with status in plain text, fixed 40-char Material Name
  currentReport.materials.forEach(m => {
    const name = fmt(m.name || "", 40); // fixed to 40 characters
    const poQty = m.poQty || "";
    const deliveredQty = m.deliveredQty || "";
    const unit = m.unit || "";
    const status = m.status || "";
    const observation = m.observation || "";

    body += `>>> ${name} --- PO Qty : ${poQty} --- Delivered Qty : ${deliveredQty} ${unit} --- Status : ${status} --- Observation : ${observation}${nl}`;
    body += `_______________________________________________________________________________________________________________________________________________________________________________${nl}`;
  });

  body += `${nl}Conclusion: ${currentReport.conclusionNote || ""}${nl}${nl}`;

  if (capturedMedia.length > 0) {
    body += `Attached Media:${nl}`;
    capturedMedia.forEach(file => body += `${file.name}${nl}`);
  }

  body += `Best regards,${nl}Inspection Team`;

  window.location.href = `mailto:?subject=Inspection Report - PO ${currentReport.poNumber}&body=${body}`;
}

function printReport() { window.print(); }
function viewReports() { alert("Report management can be added via server or local storage."); }
</script>
</body>
</html>
